
<!DOCTYPE html>
<html lang="ru">
<head>

  
  <meta charset="UTF-8">
  <title>
    А не смазать ли мне мои &#34;колеса&#34;? | @xanderdin
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="http://xanderdin.github.io/ru/post/lets-lubricate-the-wheel/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">

  
  <link href="http://xanderdin.github.io/index.xml" rel="alternate" type="application/rss+xml" title="@xanderdin" />
  <link href="http://xanderdin.github.io/index.xml" rel="feed" type="application/rss+xml" title="@xanderdin" />

  
  


  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129409239-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://xanderdin.github.io/">@xanderdin</a></h1>
        
      </div>
      <div id="social" class="col span_6">
        <ul>
          
          
          
          
          <li>[<a href="http://xanderdin.github.io/en/post/lets-lubricate-the-wheel/">en</a>]</li>
        </ul>
      </div>
    </div>
  </header>



  
  <main id="single" role="main">
    <div class="article-header">
      <h1>А не смазать ли мне мои &#34;колеса&#34;?</h1>
      <div class="meta">
        2018-11-20 &nbsp;
        
        
          <br>
          Переводы:
          
            [<a href="http://xanderdin.github.io/en/post/lets-lubricate-the-wheel/">en</a>]
          
        
      </div>
    </div>
    <article>
      

<p>Как рассказал в <a href="/ru/post/lets-reinvent-the-wheel">предыдущей публикации</a>,
овладело мной внезапно желание автоматизировать свой процесс подготовки
чертежей. Автоматическая нумерация листов &ndash; отлично, но теперь мне их нужно
как-то подготовить к печати.</p>

<p>На сегодняшний день мой основной инструмент для черчения
это <a href="https://librecad.org">LibreCAD</a>. Когда делал выбор в его пользу,
среди прочих, были конечно же и такие критерии как бесплатность и открытость
исходных кодов. И на этот раз преимущество программного продукта с открытым
исходным кодом проявилось в полной мере.</p>

<p><img src="/img/post/2018112001/1.png" alt="Мой чертёж в LibreCAD" /></p>

<p>Итак, в качестве финального результата мне нужен один <em>pdf</em> файл со всеми
листами в нём. Изначально это достигалось следующим образом. Каждый лист
открывался в <em>LibreCAD</em>, далее я переходил в режим предварительного просмотра
печати, там задавался масштаб для печати, и лист центрировался. После этого
я производил печать в <em>pdf</em> файл, при этом каждый раз требовалось задавать
новое имя финального файла. После того как все листы были таким образом
сконвертированы в соответствующие <em>pdf</em> файлы, я запускал в своей системе
(<a href="https://debian.org">Debian</a>) консольную утилиту
<a href="https://manpages.debian.org/stretch/poppler-utils/pdfunite.1.en.html">pdfunite</a>
и получал на выходе все эти <em>pdf</em> файлы объединённые в один общий <em>pdf</em> файл.</p>

<p>Нетрудно представить, что данная процедура также требует много повторяющихся
ручных действий и занимает много времени. Вы можете подумать, почему нельзя
проделать все это сразу после рисования листа? Ответ прост, мне требуется
пронумеровать каждый лист и поставить общее количество листов в блоке заголовка
каждого листа, а общее количество мне неизвестно пока я не нарисую все листы.</p>

<p>Мне требовалось решение, утилита, которую я мог бы запускать в консоли, указав
каталог исходных <em>dxf</em> файлов и получить на выходе <em>pdf</em> файлы или лучше сразу
один <em>pdf</em> файл.</p>

<p>Поискав готовые решения я не нашёл ничего подходящего. Понимая, что если
<em>LibreCAD</em> печатает нужный мне <em>pdf</em>, то логично было бы как-то его и
задействовать.  Осознавая, что если сделать <em>feature request</em> разработчикам
<em>LibreCAD</em>, то скорее всего это займёт очень много времени, так как у них и
без того полно задач над чем работать. И вот в чём настоящая сила программного
обеспечения с открытыми исходными кодами &ndash; если способен, закати рукава и
доработай сам, ну и конечно же поделись с другими. Тогда я и решил
попробовать сделать такую утилиту самостоятельно. Вдохновившись ожидаемым
результатом я &ldquo;нырнул&rdquo; в код <em>LibreCAD</em>.</p>

<h2 id="разминка">Разминка</h2>

<p>Я мало знаком с <em>C++</em> и с <a href="https://www.qt.io">Qt</a>, с помощью которых написан
<em>LibreCAD</em>, но я имел  опыт программирования на <em>C</em>, а также опыт
программирования на объектно ориентированных языках, таких как <em>Java</em>
и <em>Python</em>. Поэтому &ldquo;ковыряние&rdquo; в коде <em>LibreCAD</em> не вызвало у меня каких
либо больших проблем.</p>

<p>Но прежде чем приступить к более сложному функционалу, я решил попробовать
свои силы в чём-то более простом. Так как в своих чертежах я использую
множество слоёв, мне очень не хватало функции блокировки/разблокировки всех
слоёв разом. Представьте себе картину, когда тебе требуется разблокировать
150-200 слоёв и ты делаешь это по одному. Всегда когда кликал по иконке
замочка очередного слоя мне казалось странным отсутствие такой функциональности,
притом что была реализована подобная функциональность для показа/скрытия всех
слоёв разом. Вот по её подобию и решил я добавить новую фитчу.</p>

<p>Вооружившись <a href="https://www.gnu.org/software/grep/">grep</a>&lsquo;ом
отыскал все места где коренится функциональность
показа/скрытия всех слоёв, и написал по подобию. Неожиданно быстро мой
<a href="https://github.com/LibreCAD/LibreCAD/pull/1018">pull request</a>
был принят в ветку <strong>master</strong> <em>LibreCAD</em>, что придало мне большего заряда
сил для воплощения ранее задуманного функционала.</p>

<p><img src="/img/post/2018112001/2.png" alt="Кнопки блокировки/разблокировки всех слоёв" /></p>

<h2 id="dxf2pdf">dxf2pdf</h2>

<p>Итак, воодушевившись я приступил к воплощению. Изначально я хотел сделать
отдельную утилиту по подобию имеющейся в <em>LibreCAD</em> <em>ttf2lff</em>, задействовав
при этом лишь минимум необходимого кода <em>LibreCAD</em> и не меняя код из которого
собирается сам <em>librecad</em>. Я отыскивал методы отвечающие за
печать в <em>pdf</em>, копировал их, при этом беспощядно вырезал из них всё, что мне
казалось излишним для будущей утилиты и вскоре имел уже рабочий прототип.
Однако полученные <em>pdf</em> файлы несколько отличались от того, что я получал
печатая из <em>LibreCAD</em>. Кроме того, в результате напрочь отсутствовали хэтчи
и шрифты.</p>

<p>Более детально изучив код я понял, что функционал печати в <em>pdf</em> в <em>LibreCAD</em>
имеет значительно большую зависимость от остального кода <em>LibreCAD</em>,
чем я себе изначально предполагал. Подумав, что если скопировать больше кода,
то впоследствии придётся его постоянно синхронизировать с
обновлениями/исправлениями вносимыми в <em>LibreCAD</em>. Таким образом эта идея
была отвергнута.</p>

<p>Далее я решил, что задействую весь код из <em>LibreCAD</em> подменив лишь функцию
<strong>main()</strong>, в которой бы <em>LibreCAD</em> запускался не графическим приложением,
а консольным, производил бы печать и завершал свою работу. Решение оказалось
вполне рабочим, однако на выходе я имел два бинарных исполнимых файла &ndash;
<em>librecad</em> и <em>dxf2pdf</em>, почти одинаковых по размеру, а также трудности
с компиляцией при наличии двух функций <strong>main()</strong>. Посчитав это решение
как минимум странным, решил в конце концов добавить свой код в сам <em>LibreCAD</em>.</p>

<p><img src="/img/post/2018112001/3.png" alt="Вставка моего кода в LibreCAD" /></p>

<p>Таким образом, я добавил к списку параметров командной строки подкоманду
<em>dxf2pdf</em>, при указании которой <em>LibreCAD</em> запустится в консоли и осуществит
печать указанных <em>dxf</em> файлов в соответствующее множество либо один <em>pdf</em> файл.</p>

<p>К сожалению, как стало известно позже, из-за каких-то особенностей
работы <em>Qt</em> под <em>Windows</em>, в отличии от <em>Linux</em>, в <em>Windows</em> печать не
выдаёт вообще никакого результата. Я не использую <em>Windows</em>, поэтому не
знаю что можно сделать в этом случае.</p>

<p>На данный момент <em>dxf2pdf</em> запускается следующим образом и имеет следующие
опции:</p>

<pre><code>dxf2pdf usage: librecad dxf2pdf [options] &lt;dxf_files&gt;

Print a bunch of DXF files to PDF file(s).

Examples:

  librecad dxf2pdf *.dxf    -- print all dxf files to pdf files with the same names.

  librecad dxf2pdf -o some.pdf *.dxf    -- print all dxf files to 'some.pdf' file.

Options:
  -h, --help                  Displays this help.
  -v, --version               Displays version information.
  -a, --fit                   Auto fit and center drawing to page.
  -c, --center                Auto center drawing on page.
  -k, --grayscale             Print grayscale.
  -m, --monochrome            Print monochrome (black/white).
  -p, --paper &lt;WxH&gt;           Paper size (Width x Height) in mm.
  -r, --resolution &lt;integer&gt;  Output resolution (DPI).
  -s, --scale &lt;double&gt;        Output scale. E.g.: 0.01 (for 1:100 scale).
  -o, --outfile &lt;file&gt;        Output PDF file.
  -t, --directory &lt;path&gt;      Target output directory.

Arguments:
  &lt;dxf_files&gt;                 Input DXF file(s)

</code></pre>

<p>Можно также создать ссылку <em>dxf2pdf</em> на бинарный файл <em>librecad</em>:</p>

<pre><code>ln -s librecad dxf2pdf
</code></pre>

<p>Тогда можно будет вызывать команду напрямую, например:</p>

<pre><code>dxf2pdf -o some.pdf *.dxf
</code></pre>

<p>Конечно же, создав подобный функционал мне захотелось поделиться им с
проектом от которого он полностью зависит. На этот раз сделав
<a href="https://github.com/LibreCAD/LibreCAD/pull/1023">pull request</a>
ожидание оказалось более длительным. С каждым новым днём сильнее посещали
мысли, что мой код настолько плох, что я получу отказ. Но нет, спустя примерно
неделю мой код был принят. Ура, теперь не надо часами вручную распечатывать
в <em>pdf</em> каждый из пол сотни <em>dxf</em> файлов, все делается одним нажатием
клавиши &lsquo;Enter&rsquo; за считанные секунды!</p>


      
      
    </article>
     <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'xanderdin';
    var disqus_config = function () {
      
        this.language = 'ru';
      
      
        this.page.identifier = 'lets-lubricate-the-wheel.ru';
      
    };

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  </main>

  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="http://xanderdin.github.io/ru/post/lets-reinvent-the-wheel/" rel="prev">А не изобрести ли мне &#34;велосипед&#34;?!</a></span>
    
    
      <span class="next"><a href="http://xanderdin.github.io/ru/post/gitlab-through-tor/" rel="next">GitLab через Tor</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      
      
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>








</body>
</html>

